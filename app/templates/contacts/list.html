<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contacts - Codex</title>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="card">
        <div class="card__header">
            <h1 class="card__title">Contacts</h1>
            <div class="card__header-actions">
                <button class="btn" onclick="window.location.href='{{ url_for('index') }}'">
                    <span class="btn__label">
                        <i data-lucide="arrow-left" class="btn__icon"></i>
                        Back to Dashboard
                    </span>
                </button>
            </div>
        </div>
        <div class="card__body">
            <!-- Search Box -->
            <form id="searchForm" class="search-form" onsubmit="return false;">
                <div class="search-form__controls">
                    <input
                        type="text"
                        id="searchInput"
                        name="search"
                        placeholder="Search by name, email, or phone..."
                        value="{{ search_query or '' }}"
                        class="search-form__input"
                    >
                    <button type="button" class="btn" id="clearBtn" onclick="clearSearch()" style="display: {{ 'inline-block' if search_query else 'none' }};">
                        <span class="btn__label">
                            <i data-lucide="x" class="btn__icon"></i>
                            Clear
                        </span>
                    </button>
                </div>
            </form>

            <!-- Results Info -->
            <div class="results-header">
                <p class="results-header__count" id="resultsCount">
                    {% if search_query %}
                        Showing <strong>{{ pagination.total }}</strong> results for "{{ search_query }}"
                    {% else %}
                        Total: <strong>{{ pagination.total }}</strong> contacts
                    {% endif %}
                </p>
                <div class="results-header__controls">
                    <button class="btn btn--small" onclick="toggleColumnChooser()">
                        <span class="btn__label">
                            <i data-lucide="columns" class="btn__icon"></i>
                            Columns
                        </span>
                    </button>
                    <label>
                        <input type="checkbox" id="show_inactive" onchange="toggleInactive(this.checked)" {{ 'checked' if show_inactive else '' }}>
                        Show Inactive
                    </label>
                    <label for="per_page">Per page:</label>
                    <select id="per_page" onchange="changePerPage(this.value)">
                        <option value="25" {{ 'selected' if per_page == 25 else '' }}>25</option>
                        <option value="50" {{ 'selected' if per_page == 50 else '' }}>50</option>
                        <option value="100" {{ 'selected' if per_page == 100 else '' }}>100</option>
                    </select>
                </div>
            </div>

            <!-- Column Chooser -->
            <div id="columnChooser" class="card u-mb-2" style="display: none;">
                <div class="card__body">
                    <h3 class="u-mb-1">Show/Hide Columns</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem;">
                        <label>
                            <input type="checkbox" checked disabled> Name
                        </label>
                        <label>
                            <input type="checkbox" id="col-email" checked onchange="toggleColumn('email')"> Email
                        </label>
                        <label>
                            <input type="checkbox" id="col-phone" checked onchange="toggleColumn('phone')"> Phone
                        </label>
                        <label>
                            <input type="checkbox" id="col-company" checked onchange="toggleColumn('company')"> Company
                        </label>
                    </div>
                </div>
            </div>

            <!-- Contacts Table -->
            <div class="table-wrapper">
                <table class="data-table">
                    <thead id="tableHead">
                        <tr>
                            <th data-column="name" class="sortable-header">Name</th>
                            <th data-column="email" class="sortable-header">Email</th>
                            <th data-column="phone">Phone</th>
                            <th data-column="company">Company</th>
                            <th data-column="active" class="u-text-center" id="activeHeader" style="display: {{ 'table-cell' if show_inactive else 'none' }};">Active</th>
                        </tr>
                    </thead>
                    <tbody id="contactsTableBody">
                        {% for contact in contacts %}
                        <tr>
                            <td data-column="name">
                                <a href="{{ url_for('contacts.contact_details', contact_id=contact.id) }}">
                                    <strong>{{ contact.name }}</strong>
                                </a>
                            </td>
                            <td data-column="email">
                                <a href="mailto:{{ contact.email }}">
                                    {{ contact.email }}
                                </a>
                            </td>
                            <td data-column="phone">{{ contact.mobile_phone_number or contact.work_phone_number or '-' }}</td>
                            <td data-column="company">
                                {% if contact.companies %}
                                    {% for company in contact.companies %}
                                        <a href="{{ url_for('companies.company_details', account_number=company.account_number) }}">
                                            {{ company.name }}
                                        </a>{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <span>No company</span>
                                {% endif %}
                            </td>
                            {% if show_inactive %}
                            <td data-column="active" class="u-text-center">
                                {% if contact.active %}
                                    <span class="badge badge--success">Active</span>
                                {% else %}
                                    <span class="badge badge--danger">Inactive</span>
                                {% endif %}
                            </td>
                            {% endif %}
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="{{ '5' if show_inactive else '4' }}" class="empty-state">
                                {% if search_query %}
                                    No contacts found matching "{{ search_query }}". Try a different search term.
                                {% else %}
                                    No contacts found. Run PSA sync to import data.
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div class="pagination" id="paginationControls" style="display: {{ 'flex' if pagination.pages > 1 else 'none' }};">
                <!-- Pagination will be dynamically updated -->
            </div>
        </div>
    </div>

    <script>
        let currentPage = {{ pagination.page }};
        let currentPerPage = {{ per_page }};
        let currentSortBy = '{{ sort_by }}';
        let currentOrder = '{{ order }}';
        let currentSearch = '{{ search_query or '' }}';
        let currentShowInactive = {{ 'true' if show_inactive else 'false' }};
        let searchTimeout = null;

        function getBasePath() {
            const path = window.location.pathname;
            if (path.startsWith('/codex/')) {
                return '/codex';
            }
            return '';
        }

        // Real-time search with debouncing
        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentSearch = e.target.value.trim();
                currentPage = 1;
                loadContacts();
                document.getElementById('clearBtn').style.display = currentSearch ? 'inline-block' : 'none';
            }, 300);
        });

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            currentSearch = '';
            currentPage = 1;
            document.getElementById('clearBtn').style.display = 'none';
            loadContacts();
        }

        function changePerPage(value) {
            currentPerPage = parseInt(value);
            currentPage = 1;
            loadContacts();
        }

        function toggleInactive(checked) {
            currentShowInactive = checked;
            currentPage = 1;
            loadContacts();
        }

        function changePage(page) {
            currentPage = page;
            loadContacts();
        }

        async function loadContacts() {
            const basePath = getBasePath();
            const params = new URLSearchParams({
                page: currentPage,
                per_page: currentPerPage,
                sort_by: currentSortBy,
                order: currentOrder,
                search: currentSearch,
                show_inactive: currentShowInactive ? '1' : '0'
            });

            try {
                const response = await fetch(`${basePath}/contacts/api/search?${params}`, {
                    credentials: 'same-origin'
                });

                if (!response.ok) throw new Error('Failed to fetch contacts');

                const data = await response.json();
                updateTable(data.contacts);
                updatePagination(data.pagination);
                updateResultsCount(data.pagination.total);
                updateActiveHeader();
                lucide.createIcons();
            } catch (error) {
                console.error('Error loading contacts:', error);
                alert('Error loading contacts. Please try again.');
            }
        }

        function updateTable(contacts) {
            const tbody = document.getElementById('contactsTableBody');
            const basePath = getBasePath();
            const colSpan = currentShowInactive ? 5 : 4;

            if (contacts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${colSpan}" class="empty-state">
                            ${currentSearch ?
                                `No contacts found matching "${currentSearch}". Try a different search term.` :
                                'No contacts found. Run PSA sync to import data.'}
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = contacts.map(contact => {
                const phone = contact.mobile_phone_number || contact.work_phone_number || '-';
                const companyDisplay = contact.company_count > 0 ? `${contact.company_count} companies` : 'No company';
                const activeCell = currentShowInactive ? `
                    <td data-column="active" class="u-text-center">
                        ${contact.active ?
                            '<span class="badge badge--success">Active</span>' :
                            '<span class="badge badge--danger">Inactive</span>'}
                    </td>
                ` : '';

                return `
                    <tr>
                        <td data-column="name">
                            <a href="${basePath}/contacts/${contact.id}">
                                <strong>${contact.name}</strong>
                            </a>
                        </td>
                        <td data-column="email">
                            <a href="mailto:${contact.email}">
                                ${contact.email}
                            </a>
                        </td>
                        <td data-column="phone">${phone}</td>
                        <td data-column="company">${companyDisplay}</td>
                        ${activeCell}
                    </tr>
                `;
            }).join('');

            // Re-apply column visibility preferences
            loadColumnPreferences();
        }

        function updateActiveHeader() {
            const header = document.getElementById('activeHeader');
            header.style.display = currentShowInactive ? 'table-cell' : 'none';
        }

        function updatePagination(pagination) {
            const container = document.getElementById('paginationControls');

            if (pagination.pages <= 1) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'flex';
            let html = '';

            if (pagination.has_prev) {
                html += `
                    <button class="btn" onclick="changePage(1)">
                        <span class="btn__label">
                            <i data-lucide="chevrons-left" class="btn__icon"></i>
                            First
                        </span>
                    </button>
                    <button class="btn" onclick="changePage(${pagination.prev_num})">
                        <span class="btn__label">
                            <i data-lucide="chevron-left" class="btn__icon"></i>
                            Previous
                        </span>
                    </button>
                `;
            }

            html += `<span class="pagination__info">Page ${pagination.page} of ${pagination.pages}</span>`;

            if (pagination.has_next) {
                html += `
                    <button class="btn" onclick="changePage(${pagination.next_num})">
                        <span class="btn__label">
                            Next
                            <i data-lucide="chevron-right" class="btn__icon"></i>
                        </span>
                    </button>
                    <button class="btn" onclick="changePage(${pagination.pages})">
                        <span class="btn__label">
                            Last
                            <i data-lucide="chevrons-right" class="btn__icon"></i>
                        </span>
                    </button>
                `;
            }

            container.innerHTML = html;

            // Re-initialize lucide icons for pagination buttons
            lucide.createIcons();
        }

        function updateResultsCount(total) {
            const countElement = document.getElementById('resultsCount');
            if (currentSearch) {
                countElement.innerHTML = `Showing <strong>${total}</strong> results for "${currentSearch}"`;
            } else {
                countElement.innerHTML = `Total: <strong>${total}</strong> contacts`;
            }
        }

        function toggleColumnChooser() {
            const chooser = document.getElementById('columnChooser');
            chooser.style.display = chooser.style.display === 'none' ? 'block' : 'none';
        }

        function toggleColumn(columnName) {
            const isChecked = document.getElementById(`col-${columnName}`).checked;
            const headers = document.querySelectorAll(`th[data-column="${columnName}"]`);
            const cells = document.querySelectorAll(`td[data-column="${columnName}"]`);

            headers.forEach(th => {
                th.style.display = isChecked ? '' : 'none';
            });

            cells.forEach(td => {
                td.style.display = isChecked ? '' : 'none';
            });

            // Save preference to localStorage
            localStorage.setItem(`contacts_column_${columnName}`, isChecked);
        }

        function loadColumnPreferences() {
            const columns = ['email', 'phone', 'company'];
            columns.forEach(column => {
                const saved = localStorage.getItem(`contacts_column_${column}`);
                if (saved !== null) {
                    const isVisible = saved === 'true';
                    document.getElementById(`col-${column}`).checked = isVisible;
                    toggleColumn(column);
                }
            });
        }

        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadColumnPreferences();

            // Initialize pagination on page load
            const initialPagination = {
                page: {{ pagination.page }},
                pages: {{ pagination.pages }},
                total: {{ pagination.total }},
                has_prev: {{ 'true' if pagination.has_prev else 'false' }},
                has_next: {{ 'true' if pagination.has_next else 'false' }},
                prev_num: {{ pagination.prev_num if pagination.has_prev else 1 }},
                next_num: {{ pagination.next_num if pagination.has_next else 1 }}
            };
            updatePagination(initialPagination);

            // Re-render icons after pagination is created
            setTimeout(() => lucide.createIcons(), 100);
        });
    </script>
    <div class="version-footer">
        <span class="version-footer__text">{{ app_service_name }} v{{ app_version }}</span>
    </div>
</body>
</html>
