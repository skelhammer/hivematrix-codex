<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Settings - Codex</title>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div class="card">
        <div class="card__header">
            <h1 class="card__title">Admin Settings</h1>
            <div class="card__header-actions">
                <button class="btn" onclick="window.location.href='{{ url_for('index') }}'">
                    <span class="btn__label">
                        <i data-lucide="arrow-left" class="btn__icon"></i>
                        Back to Dashboard
                    </span>
                </button>
            </div>
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            <div class="toast-container" id="toast-container">
                {% for category, message in messages %}
                    <div class="toast toast--{{ 'success' if category == 'success' else 'warning' if category == 'warning' else 'info' if category == 'info' else 'error' }}" onclick="dismissToast(this)">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
            {% endif %}
        {% endwith %}
    </div>

    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Data Sync Center</h2>
        </div>
        <div class="card__body">
            <div class="u-mb-2">
                <h3 class="u-mt-0">PSA Sync ({{ psa_config.default_provider | title }})</h3>
                <div class="u-flex u-flex-gap u-flex-wrap">
                    <button class="btn btn--primary" onclick="syncPSA()" id="sync-psa-btn">
                        <span class="btn__label">
                            <i data-lucide="clipboard-list" class="btn__icon"></i>
                            Sync PSA
                        </span>
                    </button>
                    <button class="btn btn--primary" onclick="syncTickets()" id="sync-tickets-btn">
                        <span class="btn__label">
                            <i data-lucide="ticket" class="btn__icon"></i>
                            Sync PSA Tickets
                        </span>
                    </button>
                    <button class="btn btn--primary" onclick="syncTicketsFullHistory()" id="sync-tickets-history-btn">
                        <span class="btn__label">
                            <i data-lucide="history" class="btn__icon"></i>
                            Sync PSA Full History
                        </span>
                    </button>
                    <button class="btn btn--primary" onclick="createAccountNumbers()" id="create-acct-btn">
                        <span class="btn__label">
                            <i data-lucide="hash" class="btn__icon"></i>
                            Create Account Numbers & Push to PSA
                        </span>
                    </button>
                </div>
            </div>

            <div class="section-divider"></div>

            <div class="u-my-2">
                <h3 class="u-mt-0">RMM Sync{% if rmm_config.default_provider %} ({{ rmm_config.default_provider | title }}){% endif %}</h3>
                <div class="u-flex u-flex-gap u-flex-wrap">
                    <button class="btn btn--primary" onclick="syncRMM()" id="sync-rmm-btn">
                        <span class="btn__label">
                            <i data-lucide="monitor" class="btn__icon"></i>
                            Sync RMM
                        </span>
                    </button>
                    <button class="btn btn--primary" onclick="pushToDatto()" id="push-datto-btn">
                        <span class="btn__label">
                            <i data-lucide="upload" class="btn__icon"></i>
                            Push Account Numbers to RMM
                        </span>
                    </button>
                </div>
            </div>

            <div class="section-divider"></div>

            <div class="u-my-2">
                <h3 class="u-mt-0">Keycloak</h3>
                <div class="u-flex u-flex-gap u-flex-wrap">
                    <button class="btn btn--primary" onclick="syncAgents()" id="sync-agents-btn">
                        <span class="btn__label">
                            <i data-lucide="users-2" class="btn__icon"></i>
                            Sync Keycloak Agents
                        </span>
                    </button>
                </div>
            </div>

        </div>
    </div>

    <div class="card u-hidden" id="sync-progress-card">
        <div class="card__header">
            <h2 class="card__title">Sync Progress</h2>
        </div>
        <div class="card__body">
            <p id="sync-status" class="u-my-1 u-font-medium"></p>
            <div class="code-block u-my-1 u-text-small u-overflow-auto" id="sync-output"></div>
            <p id="sync-elapsed" class="u-my-1 u-text-secondary u-text-small"></p>
        </div>
    </div>

    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Recent Sync History</h2>
        </div>
        <div class="card__body">
            {% if recent_jobs %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Sync Type</th>
                        <th>Started</th>
                        <th>Duration</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job in recent_jobs %}
                    <tr>
                        <td>
                            <strong>{{ job.display_name }}</strong>
                        </td>
                        <td class="u-text-small">
                            {{ job.started_at if job.started_at else 'N/A' }}
                        </td>
                        <td class="u-text-small">
                            {% if job.duration %}
                                {{ job.duration }}
                            {% elif job.status == 'running' %}
                                In progress...
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if job.status == 'completed' and job.success %}
                                <span class="status-text status-text--success u-font-medium">Success</span>
                            {% elif job.status == 'completed' %}
                                <span class="status-text status-text--warning u-font-medium">Completed with errors</span>
                            {% elif job.status == 'running' %}
                                <span class="status-text status-text--info u-font-medium">Running</span>
                            {% else %}
                                <span class="status-text status-text--error u-font-medium">Failed</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn--primary btn--small" onclick="viewJobDetails('{{ job.id }}')">
                                <span class="btn__label">
                                    <i data-lucide="file-text" class="btn__icon"></i>
                                    View Logs
                                </span>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p class="empty-state">No sync jobs yet. Run your first sync above!</p>
            {% endif %}
        </div>
    </div>

    <div id="jobModal" class="modal">
        <div class="modal__dialog">
            <div class="modal__header">
                <h2 class="modal__title">Sync Job Details</h2>
                <button class="modal__close" onclick="closeJobModal()">&times;</button>
            </div>
            <div class="modal__body u-overflow-auto" id="jobModalContent">
                Loading...
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Database Statistics</h2>
        </div>
        <div class="card__body">
            <table>
                <thead>
                    <tr>
                        <th>Entity</th>
                        <th>Count</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Companies</td>
                        <td><strong>{{ stats.companies }}</strong></td>
                    </tr>
                    <tr>
                        <td>Contacts</td>
                        <td><strong>{{ stats.contacts }}</strong> ({{ stats.active_contacts }} active)</td>
                    </tr>
                    <tr>
                        <td>Assets</td>
                        <td><strong>{{ stats.assets }}</strong> ({{ stats.online_assets }} online)</td>
                    </tr>
                    <tr>
                        <td>Agents</td>
                        <td><strong>{{ stats.agents }}</strong> ({{ stats.enabled_agents }} enabled)</td>
                    </tr>
                    <tr>
                        <td>Tickets</td>
                        <td><strong>{{ stats.tickets }}</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <div class="card__header">
            <h2 class="card__title">PSA Provider Selection</h2>
        </div>
        <div class="card__body">
            <p>Select which PSA (Professional Services Automation) system Codex should use for syncing tickets, companies, and contacts.</p>

            <form method="POST" action="{{ url_for('admin.update_psa_provider') }}" class="form">
                <div class="form__group">
                    <label for="default_provider" class="form__label">Active PSA Provider:</label>
                    <select id="default_provider" name="default_provider" class="form__select">
                        <option value="freshservice" {% if psa_config.default_provider == 'freshservice' %}selected{% endif %}>
                            Freshservice
                        </option>
                        <option value="superops" {% if psa_config.default_provider == 'superops' %}selected{% endif %}>
                            Superops
                        </option>
                    </select>
                </div>
                <p class="u-text-small u-text-secondary u-mt-1">
                    <em>Note: Changing the provider requires a Codex restart for scheduler changes to take effect.</em>
                </p>
                <button type="submit" class="btn btn--primary u-mt-2">
                    <span class="btn__label">Set Active PSA Provider</span>
                </button>
            </form>

            <div class="u-mt-2">
                <strong>Current Provider:</strong>
                <span class="badge badge--{% if psa_config.default_provider == 'freshservice' %}primary{% else %}info{% endif %}">
                    {{ psa_config.default_provider | title }}
                </span>
            </div>
        </div>
    </div>

    {% if psa_config.default_provider == 'freshservice' %}
    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Freshservice Integration</h2>
        </div>
        <div class="card__body">
            <table>
                <tbody>
                    <tr>
                        <td><strong>Domain:</strong></td>
                        <td>{{ fs_config.domain }}</td>
                    </tr>
                    <tr>
                        <td><strong>API Key:</strong></td>
                        <td>
                            {% if fs_config.api_key_set %}
                                <span class="status-text status-text--success">Configured</span>
                            {% else %}
                                <span class="status-text status-text--danger">Not configured</span>
                            {% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>

            <h3>Update Freshservice Configuration</h3>
            <form method="POST" action="{{ url_for('admin.update_freshservice') }}" class="form">
                <div class="form__group">
                    <label for="fs_domain" class="form__label">API Domain:</label>
                    <input type="text" id="fs_domain" name="fs_domain"
                           value="{{ fs_config.domain }}"
                           placeholder="your-domain.freshservice.com"
                           class="form__input">
                </div>
                <div class="form__group">
                    <label for="fs_web_domain" class="form__label">Web Domain (for ticket links):</label>
                    <input type="text" id="fs_web_domain" name="fs_web_domain"
                           value="{{ fs_config.web_domain }}"
                           placeholder="helpdesk.yourdomain.com (leave blank to use API domain)"
                           class="form__input">
                </div>
                <div class="form__group">
                    <label for="fs_api_key" class="form__label">API Key:</label>
                    <input type="password" id="fs_api_key" name="fs_api_key"
                           placeholder="Enter new API key (leave blank to keep current)"
                           class="form__input">
                </div>
                <button type="submit" class="btn btn--primary u-mt-2">
                    <span class="btn__label">Save Freshservice Settings</span>
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    {% if psa_config.default_provider == 'superops' %}
    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Superops Integration</h2>
        </div>
        <div class="card__body">
            <table>
                <tbody>
                    <tr>
                        <td><strong>API URL:</strong></td>
                        <td>{{ superops_config.api_url or 'Not configured' }}</td>
                    </tr>
                    <tr>
                        <td><strong>API Key:</strong></td>
                        <td>
                            {% if superops_config.api_key_set %}
                                <span class="status-text status-text--success">Configured</span>
                            {% else %}
                                <span class="status-text status-text--danger">Not configured</span>
                            {% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>

            <h3>Update Superops Configuration</h3>
            <form method="POST" action="{{ url_for('admin.update_superops') }}" class="form">
                <div class="form__group">
                    <label for="superops_api_url" class="form__label">API URL:</label>
                    <input type="text" id="superops_api_url" name="superops_api_url"
                           value="{{ superops_config.api_url }}"
                           placeholder="https://api.superops.ai/v1"
                           class="form__input">
                </div>
                <div class="form__group">
                    <label for="superops_api_key" class="form__label">API Key:</label>
                    <input type="password" id="superops_api_key" name="superops_api_key"
                           placeholder="Enter new API key (leave blank to keep current)"
                           class="form__input">
                </div>
                <button type="submit" class="btn btn--primary u-mt-2">
                    <span class="btn__label">Save Superops Settings</span>
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card__header">
            <h2 class="card__title">RMM Provider Selection</h2>
        </div>
        <div class="card__body">
            <p>Select which RMM (Remote Monitoring and Management) system Codex should use for syncing assets and devices.</p>

            <form method="POST" action="{{ url_for('admin.update_rmm_provider') }}" class="form">
                <div class="form__group">
                    <label for="rmm_default_provider" class="form__label">Active RMM Provider:</label>
                    <select id="rmm_default_provider" name="default_provider" class="form__select">
                        <option value="datto" {% if rmm_config.default_provider == 'datto' %}selected{% endif %}>
                            Datto RMM
                        </option>
                        <option value="superops" {% if rmm_config.default_provider == 'superops' %}selected{% endif %}>
                            SuperOps RMM
                        </option>
                    </select>
                </div>
                <p class="u-text-small u-text-secondary u-mt-1">
                    <em>Note: Changing the provider requires a Codex restart for scheduler changes to take effect.</em>
                </p>
                <button type="submit" class="btn btn--primary u-mt-2">
                    <span class="btn__label">Set Active RMM Provider</span>
                </button>
            </form>

            <div class="u-mt-2">
                <strong>Current Provider:</strong>
                <span class="badge badge--{% if rmm_config.default_provider == 'datto' %}primary{% else %}info{% endif %}">
                    {{ rmm_config.default_provider | title }}
                </span>
            </div>
        </div>
    </div>

    {% if rmm_config.default_provider == 'datto' %}
    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Datto RMM Integration</h2>
        </div>
        <div class="card__body">
            <table>
                <tbody>
                    <tr>
                        <td><strong>API Endpoint:</strong></td>
                        <td>{{ datto_config.api_endpoint }}</td>
                    </tr>
                    <tr>
                        <td><strong>Public Key:</strong></td>
                        <td>
                            {% if datto_config.public_key_set %}
                                <span class="status-text status-text--success">Configured</span>
                            {% else %}
                                <span class="status-text status-text--danger">Not configured</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Secret Key:</strong></td>
                        <td>
                            {% if datto_config.secret_key_set %}
                                <span class="status-text status-text--success">Configured</span>
                            {% else %}
                                <span class="status-text status-text--danger">Not configured</span>
                            {% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>

            <h3>Update Datto RMM Configuration</h3>
            <form method="POST" action="{{ url_for('admin.update_datto') }}" class="form">
                <div class="form__group">
                    <label for="datto_endpoint" class="form__label">API Endpoint:</label>
                    <select id="datto_endpoint" name="datto_endpoint" class="form__select">
                        <option value="https://zinfandel-api.centrastage.net"
                                {% if datto_config.api_endpoint == 'https://zinfandel-api.centrastage.net' %}selected{% endif %}>
                            US - https://zinfandel-api.centrastage.net
                        </option>
                        <option value="https://concord-api.centrastage.net"
                                {% if datto_config.api_endpoint == 'https://concord-api.centrastage.net' %}selected{% endif %}>
                            EU - https://concord-api.centrastage.net
                        </option>
                        <option value="https://pinotgrigio-api.centrastage.net"
                                {% if datto_config.api_endpoint == 'https://pinotgrigio-api.centrastage.net' %}selected{% endif %}>
                            AU - https://pinotgrigio-api.centrastage.net
                        </option>
                    </select>
                </div>
                <div class="form__group">
                    <label for="datto_public_key" class="form__label">Public Key:</label>
                    <input type="text" id="datto_public_key" name="datto_public_key"
                           placeholder="Enter new public key (leave blank to keep current)"
                           class="form__input">
                </div>
                <div class="form__group">
                    <label for="datto_secret_key" class="form__label">Secret Key:</label>
                    <input type="password" id="datto_secret_key" name="datto_secret_key"
                           placeholder="Enter new secret key (leave blank to keep current)"
                           class="form__input">
                </div>
                <button type="submit" class="btn btn--primary u-mt-2">
                    <span class="btn__label">Save Datto Settings</span>
                </button>
            </form>
        </div>
    </div>
    {% endif %}

    {% if rmm_config.default_provider == 'superops' %}
    <div class="card">
        <div class="card__header">
            <h2 class="card__title">SuperOps RMM Integration</h2>
        </div>
        <div class="card__body">
            <div class="info-message u-mb-2">
                <strong>Note:</strong> SuperOps RMM integration is not yet implemented. This is a placeholder for future use.
            </div>
            <table>
                <tbody>
                    <tr>
                        <td><strong>API Key:</strong></td>
                        <td>
                            <span class="status-text status-text--warning">Not configured</span>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Region:</strong></td>
                        <td>
                            <span class="status-text status-text--warning">Not configured</span>
                        </td>
                    </tr>
                </tbody>
            </table>

            <h3>Update SuperOps RMM Configuration</h3>
            <p class="u-text-secondary u-text-small">Configuration form will be available when SuperOps RMM provider is implemented.</p>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Automatic Sync Scheduler</h2>
        </div>
        <div class="card__body">
            <p>Codex can automatically sync data on a schedule. Current configuration:</p>

            <div class="info-grid">
                <div class="info-item">
                    <span class="info-item__label">PSA Sync ({{ scheduler_config.default_provider | title }}):</span>
                    <span class="info-item__value">
                        {% if scheduler_config.psa_enabled %}
                            <span class="badge badge--success">Enabled</span> ({{ scheduler_config.psa_schedule }})
                        {% else %}
                            <span class="badge badge--danger">Disabled</span>
                        {% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-item__label">RMM Sync{% if rmm_config.default_provider %} ({{ rmm_config.default_provider | title }}){% endif %}:</span>
                    <span class="info-item__value">
                        {% if scheduler_config.rmm_enabled %}
                            <span class="badge badge--success">Enabled</span> ({{ scheduler_config.rmm_schedule }})
                        {% else %}
                            <span class="badge badge--danger">Disabled</span>
                        {% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-item__label">Tickets Sync:</span>
                    <span class="info-item__value">
                        {% if scheduler_config.tickets_enabled %}
                            <span class="badge badge--success">Enabled</span> ({{ scheduler_config.tickets_schedule }})
                        {% else %}
                            <span class="badge badge--danger">Disabled</span>
                        {% endif %}
                    </span>
                </div>
                <div class="info-item">
                    <span class="info-item__label">Run on Startup:</span>
                    <span class="info-item__value">
                        {% if scheduler_config.run_on_startup %}
                            <span class="badge badge--success">Yes</span>
                        {% else %}
                            <span class="badge">No</span>
                        {% endif %}
                    </span>
                </div>
            </div>

            <h3>Scheduled Jobs</h3>
            {% if scheduler_jobs %}
            <div class="table-wrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Job Name</th>
                            <th>Next Run</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in scheduler_jobs %}
                        <tr>
                            <td>{{ job.name }}</td>
                            <td>{{ job.next_run }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="info-message">No jobs currently scheduled. Check your instance/codex.conf [scheduler] section.</p>
            {% endif %}

            <h3>Modify Scheduler Settings</h3>
            <p>To change scheduler settings, edit <code>instance/codex.conf</code> and restart Codex:</p>
            <pre><code>[psa]
default_provider = freshservice  # or superops

[rmm]
default_provider = datto  # or superops

[scheduler]
sync_psa_enabled = true
sync_rmm_enabled = true  # RMM sync (applies to active provider)
sync_tickets_enabled = true
sync_psa_schedule = daily  # Options: daily, hourly
sync_rmm_schedule = daily  # Options: daily, hourly
sync_tickets_schedule = frequent  # Options: frequent (3 min), hourly, daily
sync_run_on_startup = false</code></pre>
        </div>
    </div>

    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Data Management</h2>
        </div>
        <div class="card__body">
            <p><strong>⚠️ Warning:</strong> These operations are destructive and cannot be undone!</p>

            <h3>Clear Database Records</h3>
            <form method="POST" action="{{ url_for('admin.clear_data') }}" class="form"
                  onsubmit="return confirm('Are you sure you want to delete this data? This action cannot be undone!');">
                <div class="form__group">
                    <label for="data_type" class="form__label">Select data type to clear:</label>
                    <select id="data_type" name="data_type" required class="form__select">
                        <option value="">-- Select Type --</option>
                        <option value="assets">Assets Only ({{ stats.assets }} records)</option>
                        <option value="contacts">Contacts Only ({{ stats.contacts }} records)</option>
                        <option value="companies">Companies Only ({{ stats.companies }} records)</option>
                        <option value="agents">Agents Only ({{ stats.agents }} records)</option>
                        <option value="all">ALL DATA (Everything)</option>
                    </select>
                </div>
                <button type="submit" class="btn btn--danger u-mt-2">
                    <span class="btn__label">
                        <i data-lucide="alert-triangle" class="btn__icon"></i>
                        Delete Selected Data
                    </span>
                </button>
            </form>
        </div>
    </div>

    <script>
        let currentJobId = null;
        let pollInterval = null;
        let startTime = null;

        function showSyncProgress() {
            document.getElementById('sync-progress-card').classList.remove('u-hidden');
        }

        function hideSyncProgress() {
            document.getElementById('sync-progress-card').classList.add('u-hidden');
        }

        function viewJobDetails(jobId) {
            document.getElementById('jobModal').classList.add('active');
            document.getElementById('jobModalContent').innerHTML = 'Loading...';

            const basePath = window.location.pathname.startsWith('/codex/') ? '/codex' : '';
            fetch(`${basePath}/sync/status/${jobId}`, {
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                const statusClass = data.success ? 'status-text--success' : (data.status === 'failed' ? 'status-text--error' : 'status-text--info');
                const statusText = data.success ? 'Success' : (data.status === 'failed' ? 'Failed' : data.status);

                let html = `
                    <div class="u-mb-2">
                        <p><strong>Job ID:</strong> ${data.id}</p>
                        <p><strong>Script:</strong> ${data.script}</p>
                        <p><strong>Status:</strong> <span class="status-text ${statusClass} u-font-medium">${statusText}</span></p>
                        <p><strong>Started:</strong> ${data.started_at || 'N/A'}</p>
                        <p><strong>Completed:</strong> ${data.completed_at || 'Still running'}</p>
                    </div>
                `;

                if (data.output) {
                    html += `
                        <div class="u-mt-2">
                            <h4 class="u-mb-1">Output:</h4>
                            <pre class="code-block u-text-small u-overflow-auto">${data.output}</pre>
                        </div>
                    `;
                }

                if (data.error) {
                    html += `
                        <div class="u-mt-2">
                            <h4 class="u-mb-1 u-text-danger">Error:</h4>
                            <pre class="code-block code-block--error u-text-small u-overflow-auto">${data.error}</pre>
                        </div>
                    `;
                }

                document.getElementById('jobModalContent').innerHTML = html;

                // Re-initialize Lucide icons after DOM update
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            })
            .catch(error => {
                document.getElementById('jobModalContent').innerHTML = `<p class="status-text status-text--error">Error loading job details: ${error.message}</p>`;
            });
        }

        function closeJobModal() {
            document.getElementById('jobModal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.getElementById('jobModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeJobModal();
            }
        });

        function updateElapsedTime() {
            if (!startTime) return;
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('sync-elapsed').textContent =
                `Elapsed: ${minutes}m ${seconds}s`;
        }

        function pollJobStatus(jobId, buttonId, buttonLabel) {
            const basePath = window.location.pathname.startsWith('/codex/') ? '/codex' : '';
            fetch(`${basePath}/sync/status/${jobId}`, {
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                const status = document.getElementById('sync-status');
                const output = document.getElementById('sync-output');

                // Update status
                status.className = ''; // Clear existing classes
                if (data.status === 'running') {
                    status.textContent = `Syncing ${data.script}... (${data.status})`;
                    status.classList.add('status-text', 'status-text--info', 'u-font-medium');
                } else if (data.status === 'completed') {
                    status.textContent = data.success
                        ? `${data.script} sync completed successfully!`
                        : `${data.script} sync completed with errors`;
                    status.classList.add('status-text', 'u-font-medium',
                        data.success ? 'status-text--success' : 'status-text--error');
                } else if (data.status === 'failed') {
                    status.textContent = `${data.script} sync failed`;
                    status.classList.add('status-text', 'status-text--error', 'u-font-medium');
                }

                // Re-initialize Lucide icons after DOM update
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }

                // Update output
                if (data.output) {
                    output.textContent = data.output;
                    output.scrollTop = output.scrollHeight;
                }
                if (data.error) {
                    output.textContent += '\n\nERROR:\n' + data.error;
                    output.scrollTop = output.scrollHeight;
                }

                // Update elapsed time
                updateElapsedTime();

                // If done, stop polling
                if (data.status === 'completed' || data.status === 'failed') {
                    clearInterval(pollInterval);
                    pollInterval = null;
                    currentJobId = null;

                    const btn = document.getElementById(buttonId);
                    btn.disabled = false;
                    btn.querySelector('.btn__label').textContent = buttonLabel;

                    // Show toast notification
                    if (data.status === 'completed' && data.success) {
                        showToast(`${data.script} sync completed successfully!`, 'success');
                    } else if (data.status === 'failed' || !data.success) {
                        showToast(`${data.script} sync failed`, 'error');
                    }

                    // Reload page after 3 seconds to show updated history
                    setTimeout(() => location.reload(), 3000);
                }
            })
            .catch(error => {
                console.error('Poll error:', error);
            });
        }

        function startSync(url, buttonId, buttonLabel, syncName) {
            const btn = document.getElementById(buttonId);
            const status = document.getElementById('sync-status');
            const output = document.getElementById('sync-output');

            btn.disabled = true;
            btn.querySelector('.btn__label').textContent = 'Starting...';

            showSyncProgress();
            status.textContent = `Starting ${syncName} sync...`;
            status.className = 'u-text-secondary';
            output.textContent = 'Initializing...\n';
            startTime = Date.now();

            fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.job_id) {
                    currentJobId = data.job_id;
                    output.textContent += `Job ID: ${data.job_id}\n`;
                    output.textContent += `Sync started at ${new Date().toLocaleTimeString()}\n\n`;

                    // Start polling every 2 seconds
                    pollInterval = setInterval(() => {
                        pollJobStatus(data.job_id, buttonId, buttonLabel);
                    }, 2000);

                    // Do first poll immediately
                    pollJobStatus(data.job_id, buttonId, buttonLabel);
                } else {
                    status.textContent = 'Failed to start sync: ' + (data.error || 'Unknown error');
                    status.className = 'status-text status-text--error';
                    btn.disabled = false;
                    btn.querySelector('.btn__label').textContent = buttonLabel;
                }
            })
            .catch(error => {
                status.textContent = 'Error: ' + error.message;
                status.className = 'status-text status-text--error';
                btn.disabled = false;
                btn.querySelector('.btn__label').textContent = buttonLabel;
            });
        }

        function syncPSA() {
            startSync(
                '{{ url_for("sync_psa") }}',
                'sync-psa-btn',
                'Sync PSA',
                'PSA'
            );
        }

        function syncRMM() {
            startSync(
                '{{ url_for("sync_datto") }}',
                'sync-rmm-btn',
                'Sync RMM',
                'RMM'
            );
        }

        function syncTickets() {
            startSync(
                '{{ url_for("sync_tickets") }}',
                'sync-tickets-btn',
                'Sync PSA Tickets',
                'PSA Tickets'
            );
        }

        function syncTicketsFullHistory() {
            if (!confirm('This will sync ALL {{ psa_config.default_provider | title }} ticket history. This may take a long time. Continue?')) {
                return;
            }
            startSync(
                '{{ url_for("sync_tickets_full_history") }}',
                'sync-tickets-history-btn',
                'Sync PSA Full History',
                'PSA Full History'
            );
        }

        function createAccountNumbers() {
            startSync(
                '{{ url_for("sync_create_account_numbers") }}',
                'create-acct-btn',
                'Create Account Numbers & Push to PSA',
                'Account Numbers'
            );
        }

        function pushToDatto() {
            startSync(
                '{{ url_for("sync_push_to_datto") }}',
                'push-datto-btn',
                'Push Account Numbers to RMM',
                'Push to RMM'
            );
        }

        function syncAgents() {
            startSync(
                '{{ url_for("sync_keycloak_agents") }}',
                'sync-agents-btn',
                'Sync Keycloak Agents',
                'Keycloak Agents'
            );
        }

        // Update elapsed time every second
        setInterval(updateElapsedTime, 1000);

        // Initialize Lucide icons
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });

        // Clear any orphaned intervals on page load
        window.addEventListener('beforeunload', () => {
            if (pollInterval) clearInterval(pollInterval);
        });

        // Toast notification functions
        function dismissToast(toast) {
            toast.classList.add('toast--hiding');
            setTimeout(() => toast.remove(), 300);
        }

        function showToast(message, type = 'info') {
            // Create toast container if it doesn't exist
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'toast-container';
                document.body.appendChild(container);
            }

            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast--${type}`;
            toast.textContent = message;
            toast.onclick = () => dismissToast(toast);

            // Add to container
            container.appendChild(toast);

            // Auto-dismiss after 5 seconds
            setTimeout(() => dismissToast(toast), 5000);
        }

        // Auto-dismiss existing toasts after 5 seconds
        document.querySelectorAll('.toast').forEach(toast => {
            setTimeout(() => dismissToast(toast), 5000);
        });
    </script>
    <div class="version-footer">
        <span class="version-footer__text">{{ app_service_name }} v{{ app_version }}</span>
    </div>
</body>
</html>
