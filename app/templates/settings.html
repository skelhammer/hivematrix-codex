{% extends "layout.html" %}

{% block title %}User Settings{% endblock %}

{% block content %}
    {# Toast container for notifications #}
    <div class="toast-container" id="toast-container"></div>

    <div class="page-header">
        <h1 class="page-header__title">User Settings</h1>
        <p class="page-header__description">Personalize your HiveMatrix experience</p>
    </div>

    <div class="card">
        <div class="card__body">
            <!-- User Info Section -->
            <div class="u-mb-2">
                <h2>Account Information</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-item__label">Username</span>
                        <span class="info-item__value" id="user-username">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-item__label">Email</span>
                        <span class="info-item__value" id="user-email">Loading...</span>
                    </div>
                </div>
            </div>

            <div class="section-divider"></div>

            <!-- Theme Settings Section -->
            <div class="u-mb-2">
                <h2>Appearance</h2>
                <p class="u-text-secondary u-mb-1">
                    Choose your preferred color theme. Changes apply immediately across all HiveMatrix services.
                </p>

                <div class="theme-selector">
                    <div class="theme-option" id="theme-light" onclick="selectTheme('light')">
                        <div class="theme-option__preview theme-option__preview--light">
                            <div class="preview-header"></div>
                            <div class="preview-sidebar"></div>
                            <div class="preview-content"></div>
                        </div>
                        <div class="theme-option__info">
                            <h3 class="theme-option__name">‚òÄÔ∏è Light Theme</h3>
                            <p class="theme-option__desc">Clean and bright interface</p>
                        </div>
                        <div class="theme-option__indicator"></div>
                    </div>

                    <div class="theme-option" id="theme-dark" onclick="selectTheme('dark')">
                        <div class="theme-option__preview theme-option__preview--dark">
                            <div class="preview-header"></div>
                            <div class="preview-sidebar"></div>
                            <div class="preview-content"></div>
                        </div>
                        <div class="theme-option__info">
                            <h3 class="theme-option__name">üåô Dark Theme</h3>
                            <p class="theme-option__desc">Easy on the eyes for long sessions</p>
                        </div>
                        <div class="theme-option__indicator"></div>
                    </div>
                </div>

                <!-- Color Theme Selector -->
                <div class="u-mt-2">
                    <p class="u-text-secondary u-mb-1">
                        Choose your preferred color accent. Works with both light and dark modes.
                    </p>

                    <!-- Color Theme Preview Swatches -->
                    <div class="color-preview-grid">
                        <div class="color-preview" data-color="purple" onclick="selectColorThemeByClick('purple')">
                            <div class="color-preview__swatch" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)"></div>
                            <span class="color-preview__label">Purple</span>
                        </div>
                        <div class="color-preview" data-color="blue" onclick="selectColorThemeByClick('blue')">
                            <div class="color-preview__swatch" style="background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%)"></div>
                            <span class="color-preview__label">Blue</span>
                        </div>
                        <div class="color-preview" data-color="green" onclick="selectColorThemeByClick('green')">
                            <div class="color-preview__swatch" style="background: linear-gradient(135deg, #059669 0%, #10b981 100%)"></div>
                            <span class="color-preview__label">Green</span>
                        </div>
                        <div class="color-preview" data-color="orange" onclick="selectColorThemeByClick('orange')">
                            <div class="color-preview__swatch" style="background: linear-gradient(135deg, #f97316 0%, #fb923c 100%)"></div>
                            <span class="color-preview__label">Orange</span>
                        </div>
                        <div class="color-preview" data-color="gold" onclick="selectColorThemeByClick('gold')">
                            <div class="color-preview__swatch" style="background: linear-gradient(135deg, #B39B7E 0%, #C9B697 100%)"></div>
                            <span class="color-preview__label">Gold</span>
                        </div>
                        <div class="color-preview" data-color="red" onclick="selectColorThemeByClick('red')">
                            <div class="color-preview__swatch" style="background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%)"></div>
                            <span class="color-preview__label">Red</span>
                        </div>
                        <div class="color-preview" data-color="yellow" onclick="selectColorThemeByClick('yellow')">
                            <div class="color-preview__swatch" style="background: linear-gradient(135deg, #eab308 0%, #fbbf24 100%)"></div>
                            <span class="color-preview__label">Yellow</span>
                        </div>
                        <div class="color-preview" data-color="matrix" onclick="selectColorThemeByClick('matrix')">
                            <div class="color-preview__swatch" style="background: linear-gradient(135deg, #00ff41 0%, #39ff14 100%)"></div>
                            <span class="color-preview__label">Matrix</span>
                        </div>
                        <div class="color-preview" data-color="bee" onclick="selectColorThemeByClick('bee')">
                            <div class="color-preview__swatch" style="background: linear-gradient(135deg, #FFB300 0%, #FFC107 100%)"></div>
                            <span class="color-preview__label">Bee</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-divider"></div>

            <!-- Home Page Settings Section -->
            <div class="u-mb-2">
                <h2>Home Page</h2>
                <p class="u-text-secondary u-mb-1">
                    Choose which page opens when you log in to HiveMatrix.
                </p>

                <div class="form-group">
                    <label for="home-page-select" class="form-group__label">Default Home Page:</label>
                    <select id="home-page-select" class="form-group__select" onchange="markUnsaved()">
                        <option value="helm">Helm (Dashboard)</option>
                        <option value="codex">Codex (Data Management)</option>
                        <option value="beacon">Beacon (Ticket Dashboard)</option>
                        <option value="ledger">Ledger (Billing)</option>
                        <option value="brainhair">Brainhair (AI Assistant)</option>
                    </select>
                </div>
            </div>

            <div class="section-divider"></div>

            <!-- Save Button -->
            <div class="action-footer">
                <button class="btn btn--primary" onclick="saveSettings()" id="save-btn">
                    <span class="btn__label">
                        <i data-lucide="save" class="btn__icon"></i>
                        Save Settings
                    </span>
                </button>
                <span id="save-status" class="u-ml-1 u-text-success"></span>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Toast notification functions
    function dismissToast(toast) {
            toast.classList.add('toast--hiding');
            setTimeout(() => toast.remove(), 300);
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast--${type}`;
            toast.textContent = message;
            toast.onclick = () => dismissToast(toast);
            container.appendChild(toast);
            setTimeout(() => dismissToast(toast), 8000);
        }

        let currentTheme = 'light';
        let savedTheme = 'light';
        let currentColorTheme = 'purple';
        let savedColorTheme = 'purple';
        let currentHomePage = 'helm';
        let savedHomePage = 'helm';

        function getBasePath() {
            const path = window.location.pathname;
            if (path.startsWith('/codex/')) {
                return '/codex';
            }
            return '';
        }

        async function loadSettings() {
            try {
                const basePath = getBasePath();
                const response = await fetch(`${basePath}/api/my/settings`, {
                    credentials: 'same-origin'
                });
                const data = await response.json();

                if (data.synced) {
                    document.getElementById('user-username').textContent = data.username || 'N/A';
                    document.getElementById('user-email').textContent = data.email || 'N/A';
                    currentTheme = data.theme_preference || 'light';
                    savedTheme = currentTheme;
                    selectTheme(currentTheme, false);

                    currentColorTheme = data.preferred_color_theme || 'purple';
                    savedColorTheme = currentColorTheme;
                    selectColorTheme(currentColorTheme, false);

                    currentHomePage = data.home_page_preference || 'helm';
                    savedHomePage = currentHomePage;
                    document.getElementById('home-page-select').value = currentHomePage;
                } else {
                    // User not synced yet
                    document.getElementById('user-username').textContent = 'Not synced';
                    document.getElementById('user-email').textContent = 'Not synced';
                    document.getElementById('save-status').innerHTML = '<span class="alert alert--warning">Your account hasn\'t been synced from Keycloak yet. Ask an admin to sync agents.</span>';
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                showToast('Error loading settings', 'error');
            }
        }

        function selectTheme(theme, markUnsaved = true) {
            currentTheme = theme;

            // Update UI selection indicators
            document.getElementById('theme-light').classList.toggle('selected', theme === 'light');
            document.getElementById('theme-dark').classList.toggle('selected', theme === 'dark');

            if (markUnsaved && theme !== savedTheme) {
                document.getElementById('save-status').innerHTML = '<span class="u-text-warning">Unsaved changes</span>';
            }
        }

        function selectColorTheme(colorTheme, markUnsaved = true) {
            currentColorTheme = colorTheme;

            // Update color preview selection indicators
            document.querySelectorAll('.color-preview').forEach(preview => {
                preview.classList.toggle('selected', preview.dataset.color === colorTheme);
            });

            if (markUnsaved && colorTheme !== savedColorTheme) {
                document.getElementById('save-status').innerHTML = '<span class="u-text-warning">Unsaved changes</span>';
            }
        }

        function selectColorThemeByClick(colorTheme) {
            selectColorTheme(colorTheme, true);
        }

        function markUnsaved() {
            currentHomePage = document.getElementById('home-page-select').value;
            if (currentHomePage !== savedHomePage || currentTheme !== savedTheme || currentColorTheme !== savedColorTheme) {
                document.getElementById('save-status').innerHTML = '<span class="u-text-warning">Unsaved changes</span>';
            } else {
                document.getElementById('save-status').textContent = '';
            }
        }

        async function saveSettings() {
            const saveBtn = document.getElementById('save-btn');
            const saveStatus = document.getElementById('save-status');

            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="btn__label"><i data-lucide="loader" class="btn__icon"></i>Saving...</span>';
            saveStatus.textContent = '';
            lucide.createIcons();

            try {
                const basePath = getBasePath();
                currentHomePage = document.getElementById('home-page-select').value;
                const response = await fetch(`${basePath}/api/my/settings`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        theme_preference: currentTheme,
                        preferred_color_theme: currentColorTheme,
                        home_page_preference: currentHomePage
                    }),
                    credentials: 'same-origin'
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    savedTheme = currentTheme;
                    savedColorTheme = currentColorTheme;
                    savedHomePage = currentHomePage;

                    // Apply theme changes immediately without reload
                    document.documentElement.setAttribute('data-theme', currentTheme);
                    document.documentElement.setAttribute('data-color-theme', currentColorTheme);

                    // Invalidate Nexus cache so next page load uses new theme
                    try {
                        await fetch('/api/invalidate-cache', {
                            method: 'POST',
                            credentials: 'same-origin'
                        });
                        console.log('Nexus cache invalidated');
                    } catch (cacheError) {
                        console.warn('Failed to invalidate cache:', cacheError);
                    }

                    showToast('Settings saved successfully!', 'success');
                    document.getElementById('save-status').innerHTML = '<span class="u-text-success">‚úì Saved</span>';
                } else {
                    showToast(`Error: ${result.error || 'Failed to save settings'}`, 'error');
                }
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<span class="btn__label"><i data-lucide="save" class="btn__icon"></i>Save Settings</span>';
                lucide.createIcons();
            }
        }

    // Load settings on page load
    window.addEventListener('DOMContentLoaded', () => {
        loadSettings();
        lucide.createIcons();
    });
</script>
{% endblock %}
