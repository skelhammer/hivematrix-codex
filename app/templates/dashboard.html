<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codex Dashboard</title>
</head>
<body>
    <div class="card">
        <div class="card__header">
            <h1 class="card__title">Welcome to Codex, {{ user.name }}!</h1>
        </div>
        <div class="card__body">
            <p>Username: <strong>{{ user.preferred_username }}</strong></p>
            <p>Role: <strong>{{ user.permission_level }}</strong></p>
            
            {% if user.permission_level == 'admin' %}
            <p>
                <a href="{{ url_for('admin.settings') }}">
                    <button class="btn btn--primary">
                        <span class="btn__label">âš™ï¸ Admin Settings</span>
                    </button>
                </a>
            </p>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card__header">
            <h2 class="card__title">CRM Overview</h2>
        </div>
        <div class="card__body">
            <div style="margin-bottom: 1em;">
                <h3>Companies</h3>
                <p><strong>{{ company_count }}</strong> companies in database</p>
                <a href="{{ url_for('companies.list_companies') }}">
                    <button class="btn btn--primary">
                        <span class="btn__label">View Companies</span>
                    </button>
                </a>
            </div>
            
            <div style="margin-bottom: 1em;">
                <h3>Contacts</h3>
                <p><strong>{{ contact_count }}</strong> contacts in database</p>
                <a href="{{ url_for('contacts.list_contacts') }}">
                    <button class="btn btn--primary">
                        <span class="btn__label">View Contacts</span>
                    </button>
                </a>
            </div>
            
            <div style="margin-bottom: 1em;">
                <h3>Assets</h3>
                <p><strong>{{ asset_count }}</strong> assets in database</p>
                <a href="{{ url_for('assets.list_assets') }}">
                    <button class="btn btn--primary">
                        <span class="btn__label">View Assets</span>
                    </button>
                </a>
            </div>
        </div>
    </div>

    {% if user.permission_level == 'admin' %}
    <div class="card">
        <div class="card__header">
            <h2 class="card__title">Data Sync Center</h2>
        </div>
        <div class="card__body">
            <p><strong>Sync data from external systems:</strong></p>
            <p style="margin: 10px 0; color: #666; font-size: 0.9em;">
                Codex is the central data hub. All other services pull data from Codex via API.
            </p>

            <div style="display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap;">
                <button class="btn btn--primary" onclick="syncFreshservice()" id="sync-fs-btn">
                    <span class="btn__label">ğŸ“‹ Sync Freshservice (Companies & Contacts)</span>
                </button>
                <button class="btn btn--primary" onclick="syncDatto()" id="sync-datto-btn">
                    <span class="btn__label">ğŸ’» Sync Datto RMM (Assets & Backup)</span>
                </button>
                <button class="btn btn--primary" onclick="syncTickets()" id="sync-tickets-btn">
                    <span class="btn__label">ğŸ« Sync Tickets (Full Context)</span>
                </button>
            </div>

            <div style="margin-top: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 4px;">
                <p id="sync-status" style="margin: 0; min-height: 20px;"></p>
            </div>

            <div style="margin-top: 15px; font-size: 0.85em; color: #666;">
                <p><strong>Recommended sync order:</strong></p>
                <ol style="margin: 5px 0;">
                    <li>Freshservice (companies & contacts)</li>
                    <li>Datto RMM (assets & backup data)</li>
                    <li>Tickets (billing hours)</li>
                </ol>
                <p style="margin-top: 10px;"><em>Note: Ticket sync may take several hours for initial full sync.</em></p>
            </div>
        </div>
    </div>

    <script>
        function syncFreshservice() {
            const btn = document.getElementById('sync-fs-btn');
            const status = document.getElementById('sync-status');
            btn.disabled = true;
            btn.querySelector('.btn__label').textContent = 'Syncing...';
            status.textContent = 'Starting Freshservice sync...';
            
            fetch('{{ url_for("sync_freshservice") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    status.textContent = 'âœ“ Freshservice sync complete!';
                    setTimeout(() => location.reload(), 2000);
                } else {
                    status.textContent = 'âœ— Sync failed: ' + (data.error || 'Unknown error');
                }
            })
            .catch(error => {
                status.textContent = 'âœ— Error: ' + error.message;
            })
            .finally(() => {
                btn.disabled = false;
                btn.querySelector('.btn__label').textContent = 'ğŸ“‹ Sync Freshservice (Companies & Contacts)';
            });
        }

        function syncDatto() {
            const btn = document.getElementById('sync-datto-btn');
            const status = document.getElementById('sync-status');
            btn.disabled = true;
            btn.querySelector('.btn__label').textContent = 'Syncing...';
            status.textContent = 'Starting Datto RMM sync...';

            fetch('{{ url_for("sync_datto") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    status.textContent = 'âœ“ Datto RMM sync complete!';
                    setTimeout(() => location.reload(), 2000);
                } else {
                    status.textContent = 'âœ— Sync failed: ' + (data.error || 'Unknown error');
                }
            })
            .catch(error => {
                status.textContent = 'âœ— Error: ' + error.message;
            })
            .finally(() => {
                btn.disabled = false;
                btn.querySelector('.btn__label').textContent = 'ğŸ’» Sync Datto RMM (Assets & Backup)';
            });
        }

        function syncTickets() {
            const btn = document.getElementById('sync-tickets-btn');
            const status = document.getElementById('sync-status');
            btn.disabled = true;
            btn.querySelector('.btn__label').textContent = 'Syncing...';
            status.textContent = 'Starting Freshservice ticket sync... This may take several hours for full sync.';

            fetch('{{ url_for("sync_tickets") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    status.textContent = 'âœ“ Ticket sync complete! Output: ' + (data.output || 'Success');
                    setTimeout(() => location.reload(), 3000);
                } else {
                    status.textContent = 'âœ— Sync failed: ' + (data.error || 'Unknown error');
                }
            })
            .catch(error => {
                status.textContent = 'âœ— Error: ' + error.message;
            })
            .finally(() => {
                btn.disabled = false;
                btn.querySelector('.btn__label').textContent = 'ğŸ« Sync Tickets (Full Context)';
            });
        }
    </script>
    {% endif %}
</body>
</html>
